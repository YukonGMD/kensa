<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kensa</title>

  <style>
    :root {
      --bg: #1e1e2e;
      --card-bg: #313244;
      --sidebar-bg: #181825;
      --text: #cdd6f4;
      --accent: #89b4fa;
      --green: #a6e3a1;
      --red: #f38ba8;
      --subtext: #a6adc8;
      --hover-bg: rgba(255, 255, 255, 0.05);
      --border: #45475a;
    }

    body.light-mode {
      --bg: #eff1f5;
      --card-bg: #e6e9ef;
      --sidebar-bg: #dce0e8;
      --text: #4c4f69;
      --accent: #1e66f5;
      --subtext: #9ca0b0;
      --border: #bcc0cc;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header-bar {
      display: flex;
      align-items: center;
      padding: 0 20px;
      height: 60px;
      background-color: var(--bg);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      z-index: 50;
      flex-shrink: 0;
    }

    .menu-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text);
      padding: 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      min-height: 40px;
    }
    .menu-btn:hover { background-color: var(--hover-bg); }
    .menu-btn svg { width: 28px; height: 28px; fill: currentColor; }

    h1 {
      margin: 0 0 0 15px;
      font-size: 1.5rem;
      color: var(--accent);
      flex: 1;
      white-space: nowrap;
    }

    .action-btn {
      background-color: var(--green);
      color: #111;
      border: none;
      padding: 0 16px;
      height: 36px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      transition: opacity 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-btn:hover { opacity: 0.9; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .sidebar-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 250px;
      background-color: var(--sidebar-bg);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 101;
      padding-top: 60px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }

    .nav-btn {
      background: none;
      border: none;
      color: var(--text);
      padding: 15px 25px;
      text-align: left;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 15px;
      border-left: 3px solid transparent;
    }
    .nav-btn svg { width: 20px; height: 20px; fill: currentColor; }
    .nav-btn:hover { background-color: var(--hover-bg); }
    .nav-btn.active {
      background-color: var(--hover-bg);
      border-left-color: var(--accent);
      color: var(--accent);
    }

    .main-view {
      flex: 1;
      padding: 20px;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .view-section { 
      display: none; 
      flex: 1; 
      height: 100%;
      flex-direction: column;
      overflow: hidden;
    }
    .view-section.active { display: flex; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      height: 100%;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      flex: 1; 
      overflow-y: auto; 
      scrollbar-width: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden; 
    }
    
    .card { overflow-y: auto; }
    .card::-webkit-scrollbar { display: none; }

    h2 {
      margin-top: 0;
      font-size: 1.1rem;
      border-bottom: 1px solid var(--subtext);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    ul { list-style: none; padding: 0; margin: 0; }

    .list-item {
      background: rgba(0,0,0,0.1);
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
    }

    .news-title {
      display: block;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .news-title:hover { color: var(--accent); }
    .news-date { font-size: 0.8rem; color: var(--subtext); }

    .update-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ver-tag { font-family: monospace; font-size: 0.85rem; color: var(--subtext); }
    .arrow { color: var(--accent); margin: 0 6px; }

    .pkg-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .pkg-table th { text-align: left; padding: 10px; color: var(--subtext); border-bottom: 1px solid var(--border); }
    .pkg-table td { padding: 12px 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    
    select {
      background: #eff1f5;
      color: #111;
      border: 1px solid var(--border);
      padding: 6px;
      border-radius: 4px;
      outline: none;
      max-width: 250px;
      font-family: 'Segoe UI', sans-serif;
      font-size: 0.9rem;
    }
    
    option { background: #fff; color: #000; }
    body:not(.light-mode) select { background: #b0b5c4; color: #000; }

    .setting-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #333;
      transition: .3s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(22px); }

  </style>
</head>
<body>

  <header class="header-bar">
    <button class="menu-btn" id="menu-toggle">
      <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </button>
    <h1 id="page-title">Dashboard</h1>
    <button id="global-scan-btn" class="action-btn">Refresh System</button>
  </header>

  <div class="sidebar-overlay" id="overlay"></div>

  <nav class="sidebar" id="sidebar">
    <button class="nav-btn active" onclick="nav('dashboard', 'Dashboard')">
      <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
      Dashboard
    </button>
    <button class="nav-btn" onclick="nav('packages', 'Packages')">
      <svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
      Packages
    </button>
    <button class="nav-btn" onclick="nav('settings', 'Settings')">
      <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
      Settings
    </button>
  </nav>

  <main class="main-view">
    
    <div id="view-dashboard" class="view-section active">
      <div class="grid">
        <div class="card">
          <h2>Arch News</h2>
          <ul id="news-list">
            <li style="color: var(--subtext); padding:10px;">Loading feeds...</li>
          </ul>
        </div>
        <div class="card">
          <h2>System Updates</h2>
          <button id="dash-update-btn" class="action-btn" style="width:100%; margin-bottom:15px; display:none;">Update Now</button>
          <div id="status-msg" style="color: var(--subtext); margin-bottom:10px;">Ready.</div>
          <ul id="update-list"></ul>
        </div>
      </div>
    </div>

    <div id="view-packages" class="view-section">
      <div class="card" style="height: 100%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <div style="flex:1;"></div>
          <button id="apply-pkg-btn" class="action-btn">Apply Version Changes</button>
        </div>
        <table class="pkg-table">
          <thead>
            <tr>
              <th>Package</th>
              <th>Current</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="pkg-body"></tbody>
        </table>
        <div id="pkg-empty" style="text-align:center; padding:30px; color:var(--subtext);">
          Loading packages...
        </div>
      </div>
    </div>

    <div id="view-settings" class="view-section">
      <div class="card" style="height: 100%;">
        <div class="setting-item">
          <div>
            <strong>Dark Mode</strong>
            <div style="font-size:0.85rem; color:var(--subtext);">Toggle application theme</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="toggle-theme" checked>
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div>
            <strong>Auto-Scan</strong>
            <div style="font-size:0.85rem; color:var(--subtext);">Check for updates on startup</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="toggle-autoscan">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div>
            <strong>Notifications</strong>
            <div style="font-size:0.85rem; color:var(--subtext);">Show desktop alerts (Experimental)</div>
          </div>
          <label class="switch">
            <input type="checkbox" disabled>
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

  </main>

  <script>
    const { invoke } = window.__TAURI__.core;
    
    let cachedData = [];
    const overlay = document.getElementById('overlay');
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const pageTitle = document.getElementById('page-title');
    
    menuToggle.onclick = () => {
      sidebar.classList.add('open');
      overlay.classList.add('active');
    };

    overlay.onclick = () => {
      sidebar.classList.remove('open');
      overlay.classList.remove('active');
    };

    window.nav = (viewName, displayName) => {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById('view-' + viewName).classList.add('active');
      
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      pageTitle.innerText = displayName;

      sidebar.classList.remove('open');
      overlay.classList.remove('active');

      if(viewName === 'packages') loadAllPackages();
    };

    const scanBtn = document.getElementById('global-scan-btn');
    const statusEl = document.getElementById('status-msg');
    const dashUpdateBtn = document.getElementById('dash-update-btn');
    const updateList = document.getElementById('update-list');
    const newsList = document.getElementById('news-list');

    async function fetchNews() {
      try {
        const items = await invoke('get_news');
        newsList.innerHTML = '';
        items.forEach(i => {
          const li = document.createElement('li');
          li.className = 'list-item';
          li.innerHTML = `
            <span class="news-title" onclick="invoke('open_link', {url: '${i.link}'})">${i.title} â†—</span>
            <div class="news-date">${i.pub_date}</div>
          `;
          newsList.appendChild(li);
        });
      } catch {
        newsList.innerHTML = '<li style="padding:10px; color:var(--red);">Failed to fetch news.</li>';
      }
    }

    async function scanSystem() {
      scanBtn.disabled = true;
      scanBtn.innerText = 'Scanning...';
      statusEl.innerText = ' querying databases...';
      updateList.innerHTML = '';
      dashUpdateBtn.style.display = 'none';

      try {
        const data = await invoke('get_updates');
        statusEl.innerText = `Found ${data.length} updates available.`;

        if (data.length > 0) {
          dashUpdateBtn.style.display = 'block';
        }

        data.forEach(pkg => {
          const li = document.createElement('li');
          li.className = 'list-item';
          li.innerHTML = `
            <div class="update-row">
              <strong>${pkg.name}</strong>
              <div class="ver-tag">${pkg.old_version} <span class="arrow">âžœ</span> ${pkg.new_version}</div>
            </div>
          `;
          updateList.appendChild(li);
        });

      } catch {
        statusEl.innerText = 'Error checking updates.';
      } finally {
        scanBtn.disabled = false;
        scanBtn.innerText = 'Refresh System';
      }
    }

    async function loadAllPackages() {
        const tbody = document.getElementById('pkg-body');
        const empty = document.getElementById('pkg-empty');
        
        tbody.innerHTML = '';
        empty.style.display = 'block';
        empty.innerText = 'Loading packages...';

        try {
            const data = await invoke('get_installed_packages');
            cachedData = data; 
            
            if (data.length === 0) {
                empty.innerText = 'No packages found.';
                return;
            }
            empty.style.display = 'none';

            data.forEach(p => {
                const tr = document.createElement('tr');
                let options = `<option value="current" selected>Current (${p.version})</option>`;
                if(p.cached_versions) {
                    p.cached_versions.forEach(fname => {
                       options += `<option value="${fname}">Downgrade (Cache): ${fname}</option>`;
                    });
                }
                options += `<option value="fetch_remote">ðŸ”Ž Search Arch Archive...</option>`;

                tr.innerHTML = `
                  <td><strong>${p.name}</strong></td>
                  <td style="color:var(--subtext); font-family:monospace;">${p.version}</td>
                  <td>
                    <select class="pkg-action-select" data-name="${p.name}" onchange="handlePkgSelect(this)">
                      ${options}
                    </select>
                  </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            empty.innerText = 'Error loading packages.';
        }
    }

    async function handlePkgSelect(selectEl) {
        if (selectEl.value === 'fetch_remote') {
            const pkgName = selectEl.getAttribute('data-name');
            selectEl.options[selectEl.selectedIndex].text = "Fetching...";
            selectEl.disabled = true;

            try {
                const urls = await invoke('fetch_package_history', { name: pkgName });
                selectEl.remove(selectEl.selectedIndex);
                selectEl.disabled = false;

                if (urls.length === 0) {
                    alert("No remote versions found in Archive.");
                    selectEl.value = "current";
                    return;
                }

                urls.forEach(url => {
                    const filename = url.split('/').pop();
                    const option = document.createElement('option');
                    option.value = url;
                    option.text = `Downgrade (Web): ${filename}`;
                    selectEl.add(option);
                });
                
                selectEl.value = urls[0];

            } catch (e) {
                alert("Failed to fetch history: " + e);
                selectEl.disabled = false;
                selectEl.value = "current";
            }
        }
    }

    async function applyPackageChanges() {
        const btn = document.getElementById('apply-pkg-btn');
        btn.innerText = 'Processing...';
        btn.disabled = true;

        const selects = document.querySelectorAll('.pkg-action-select');
        let targets = [];

        selects.forEach(s => {
            if (s.value !== 'current') {
                if (s.value.startsWith('http')) {
                    targets.push(s.value);
                } else {
                    targets.push("/var/cache/pacman/pkg/" + s.value);
                }
            }
        });

        if (targets.length === 0) {
            alert("No changes selected.");
            btn.innerText = 'Apply Version Changes';
            btn.disabled = false;
            return;
        }

        const command = "sudo pacman -U " + targets.join(" ");
        
        await invoke('install_updates', { targetCmd: command });
        
        btn.innerText = 'Apply Version Changes';
        btn.disabled = false;
        loadAllPackages(); 
    }

    async function triggerUpdate() {
      const btn = document.getElementById('dash-update-btn');
      btn.innerText = 'Terminal Open...';
      btn.disabled = true;
      await invoke('install_updates', { targetCmd: null });
      btn.innerText = 'Update Now';
      btn.disabled = false;
      scanSystem();
    }

    dashUpdateBtn.onclick = triggerUpdate;
    scanBtn.onclick = scanSystem;
    document.getElementById('apply-pkg-btn').onclick = applyPackageChanges;

    const themeToggle = document.getElementById('toggle-theme');
    const autoScanToggle = document.getElementById('toggle-autoscan');

    themeToggle.onchange = (e) => {
      if(!e.target.checked) document.body.classList.add('light-mode');
      else document.body.classList.remove('light-mode');
      localStorage.setItem('kensa_theme', e.target.checked ? 'dark' : 'light');
    };

    autoScanToggle.onchange = (e) => {
      localStorage.setItem('kensa_autoscan', e.target.checked);
    };

    if (localStorage.getItem('kensa_theme') === 'light') {
      document.body.classList.add('light-mode');
      themeToggle.checked = false;
    }

    if (localStorage.getItem('kensa_autoscan') === 'true') {
      autoScanToggle.checked = true;
      scanSystem();
    }

    fetchNews();
  </script>

  <script src="https://panzi.github.io/Browser-Ponies/basecfg.js"></script>
  <script src="https://panzi.github.io/Browser-Ponies/browserponies.js"></script>
  <script>
    let poniesEnabled = false;
    
    (function (cfg) {
      BrowserPonies.setBaseUrl(cfg.baseurl);
      BrowserPonies.loadConfig(BrowserPoniesBaseConfig);
      BrowserPonies.loadConfig(cfg);
    })({
      baseurl: "https://panzi.github.io/Browser-Ponies/",
      fadeDuration: 500,
      volume: 1,
      fps: 25,
      speed: 3,
      audioEnabled: false,
      showFps: false,
      showLoadProgress: true,
      speakProbability: 0.1,
      spawn: {
        "applejack": 1,
        "fluttershy": 1,
        "pinkie pie": 1,
        "rainbow dash": 1,
        "rarity": 1,
        "twilight sparkle": 1
      },
      autostart: false
    });

    document.addEventListener("keydown", (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
      
      if (e.key.toLowerCase() === "p") {
        poniesEnabled = !poniesEnabled;
        poniesEnabled ? BrowserPonies.start() : BrowserPonies.stop();
      }
    });
  </script>

</body>
</html>